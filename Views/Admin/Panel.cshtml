@using System.Text.Json
@using System.Text.Encodings.Web
@model WebProje.Models.AdminPanelViewModel
@{
    ViewData["Title"] = "Admin Paneli";
    Layout = null;
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f6f8;
        }
        .admin-shell {
            min-height: 100vh;
        }
        .admin-sidebar {
            background: #0f172a;
            color: #f8fafc;
        }
        .admin-sidebar .nav-link {
            color: rgba(248, 250, 252, 0.75);
        }
        .admin-sidebar .nav-link.active {
            background: #22d3ee;
            color: #0f172a;
            font-weight: 600;
        }
        .usage-chart-wrapper {
            position: relative;
            min-height: 320px;
        }
        .usage-chart-wrapper[data-empty="true"]::after {
            content: "Grafik için veri yok";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            background-color: rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .calendar-day {
            min-height: 90px;
            border-radius: 0.75rem;
            border: 1px solid rgba(15, 23, 42, 0.08);
            padding: 0.5rem;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            background-color: #fff;
        }
        .calendar-day.available {
            background-color: #ecfeff;
            border-color: #67e8f9;
        }
        .calendar-day.booked {
            background-color: #fee2e2;
            border-color: #f87171;
        }
        .calendar-day.past {
            opacity: 0.6;
        }
        .calendar-day.empty {
            background: transparent;
            border: none;
        }
        .calendar-day ul {
            padding-left: 1rem;
            margin-bottom: 0;
        }
        .coach-service-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.65rem;
            border-radius: 999px;
            font-size: 0.75rem;
            border: 1px solid rgba(15, 23, 42, 0.15);
            margin: 0.1rem;
            background-color: #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="container-fluid admin-shell">
        <div class="row g-0 min-vh-100">
            <aside class="col-12 col-md-4 col-lg-3 col-xxl-2 admin-sidebar d-flex flex-column p-4">
                <div class="mb-4">
                    <p class="text-white-50 mb-1 small">Hoş geldiniz</p>
                    <h5 class="mb-0">Admin Kullanıcısı</h5>
                </div>
                <div class="nav nav-pills flex-column gap-2" id="adminTab" role="tablist">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#admin-overview" type="button" role="tab">Genel Bakış</button>
                    <button class="nav-link" id="appointments-tab" data-bs-toggle="pill" data-bs-target="#admin-appointments" type="button" role="tab">Randevular</button>
                    <button class="nav-link" id="services-tab" data-bs-toggle="pill" data-bs-target="#admin-services" type="button" role="tab">Hizmetler</button>
                    <button class="nav-link" id="coaches-tab" data-bs-toggle="pill" data-bs-target="#admin-coaches" type="button" role="tab">Antrenörler</button>
                    <button class="nav-link" id="api-tab" data-bs-toggle="pill" data-bs-target="#admin-coach-api" type="button" role="tab">API</button>
                    <button class="nav-link" id="schedule-tab" data-bs-toggle="pill" data-bs-target="#admin-schedule" type="button" role="tab">Takvim</button>
                    <button class="nav-link" id="gym-tab" data-bs-toggle="pill" data-bs-target="#admin-gym" type="button" role="tab">Salon Bilgileri</button>
                </div>
                <form class="mt-auto pt-4" asp-controller="Account" asp-action="Logout" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-light w-100">Çıkış Yap</button>
                </form>
            </aside>
            <main class="col bg-light">
                <div class="tab-content py-4 px-3 px-md-5" id="adminTabContent">
                    <div class="mb-3">
                        @if (TempData["LoginMessage"] is string loginMessage)
                        {
                            <div class="alert alert-success" role="alert">@loginMessage</div>
                        }
                        @if (TempData["AdminMessage"] is string adminMessage)
                        {
                            <div class="alert alert-info" role="alert">@adminMessage</div>
                        }
                    </div>

                    <div class="tab-pane fade show active" id="admin-overview" role="tabpanel" aria-labelledby="overview-tab">
                        <div class="row g-4">
                            <div class="col-12 col-xl-5">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <h5 class="card-title d-flex align-items-center gap-2">
                                            Panel Özeti <span class="badge text-bg-info text-uppercase">Beta</span>
                                        </h5>
                                        <p class="text-muted mb-0">Kritik metrikler ve salon kullanımı tek ekranda.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-7">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between mb-3">
                                            <div>
                                                <p class="text-uppercase text-muted small mb-1">Antrenman Aktivitesi</p>
                                                <h4 class="mb-0">Salon Kullanım Grafiği</h4>
                                            </div>
                                            <div class="d-flex gap-3 flex-wrap">
                                                <div>
                                                    <label for="usagePeriodSelect" class="form-label small text-muted mb-1">Zaman Aralığı</label>
                                                    <select id="usagePeriodSelect" class="form-select form-select-sm">
                                                        <option value="weekly">7 Gün</option>
                                                        <option value="monthly" selected>30 Gün</option>
                                                        <option value="yearly">12 Ay</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label for="usageCategorySelect" class="form-label small text-muted mb-1">Aktivite Türü</label>
                                                    <select id="usageCategorySelect" class="form-select form-select-sm">
                                                        <option value="service">Hizmet</option>
                                                        <option value="coach">Koç</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="usage-chart-wrapper rounded-3 bg-body-tertiary p-3" data-empty="true">
                                            <canvas id="usageChart" aria-label="Salon kullanım grafiği" role="img"></canvas>
                                        </div>
                                        <ul class="list-group list-group-flush mt-3" id="usageSummary">
                                            <li class="list-group-item">Veri yükleniyor...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="admin-appointments" role="tabpanel" aria-labelledby="appointments-tab">
                        <div class="row g-4">
                            <div class="col-12">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="card-title mb-0">Bekleyen Randevu Talepleri</h5>
                                            <span class="badge text-bg-warning">@Model.PendingAppointments.Count() adet</span>
                                        </div>
                                        @if (!Model.PendingAppointments.Any())
                                        {
                                            <p class="text-muted mb-0">Şu anda onay bekleyen talep bulunmuyor.</p>
                                        }
                                        else
                                        {
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Üye</th>
                                                            <th>İletişim</th>
                                                            <th>Tarih / Saat</th>
                                                            <th>Koç</th>
                                                            <th>Not</th>
                                                            <th class="text-end">İşlemler</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var appointment in Model.PendingAppointments)
                                                        {
                                                            <tr>
                                                                <td>@appointment.FullName</td>
                                                                <td>
                                                                    <div>@appointment.Email</div>
                                                                    @if (!string.IsNullOrWhiteSpace(appointment.PhoneNumber))
                                                                    {
                                                                        <small class="text-muted">@appointment.PhoneNumber</small>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    @appointment.Date.ToString("dd MMM yyyy", System.Globalization.CultureInfo.GetCultureInfo("tr-TR"))<br />
                                                                    <small class="text-muted">@appointment.TimeSlot</small>
                                                                </td>
                                                                <td>@appointment.Coach</td>
                                                                <td>@(string.IsNullOrWhiteSpace(appointment.Notes) ? "-" : appointment.Notes)</td>
                                                                <td class="text-end">
                                                                    <div class="btn-group" role="group">
                                                                        <form asp-action="UpdateAppointmentStatus" method="post" class="d-inline">
                                                                            @Html.AntiForgeryToken()
                                                                            <input type="hidden" name="id" value="@appointment.Id" />
                                                                            <input type="hidden" name="actionType" value="approve" />
                                                                            <button type="submit" class="btn btn-success btn-sm">Onayla</button>
                                                                        </form>
                                                                        <form asp-action="UpdateAppointmentStatus" method="post" class="d-inline">
                                                                            @Html.AntiForgeryToken()
                                                                            <input type="hidden" name="id" value="@appointment.Id" />
                                                                            <input type="hidden" name="actionType" value="reject" />
                                                                            <button type="submit" class="btn btn-outline-danger btn-sm">Reddet</button>
                                                                        </form>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body">
                                        <h5 class="card-title">Son Kararlar</h5>
                                        @if (!Model.RecentDecisions.Any())
                                        {
                                            <p class="text-muted mb-0">Henüz onaylanmış veya reddedilmiş talep yok.</p>
                                        }
                                        else
                                        {
                                            <div class="table-responsive">
                                                <table class="table table-sm align-middle">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Üye</th>
                                                            <th>Tarih/Saat</th>
                                                            <th>Koç</th>
                                                            <th>Durum</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var decision in Model.RecentDecisions)
                                                        {
                                                            var statusClass = decision.Status == WebProje.Models.AppointmentStatus.Approved ? "success" : "danger";
                                                            <tr>
                                                                <td>@decision.FullName</td>
                                                                <td>@decision.Date.ToString("dd MMM yyyy", System.Globalization.CultureInfo.GetCultureInfo("tr-TR")) - @decision.TimeSlot</td>
                                                                <td>@decision.Coach</td>
                                                                <td><span class="badge text-bg-@statusClass">@decision.Status</span></td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="admin-services" role="tabpanel" aria-labelledby="services-tab">
                        <div class="row g-4">
                            <div class="col-12 col-xl-7">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="card-title mb-0">Hizmetler</h5>
                                            <span class="badge text-bg-secondary">@Model.Services.Count() kayıt</span>
                                        </div>
                                        @if (!Model.Services.Any())
                                        {
                                            <p class="text-muted mb-0">Henüz kayıtlı hizmet yok.</p>
                                        }
                                        else
                                        {
                                            <div class="table-responsive">
                                                <table class="table align-middle">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Ad</th>
                                                            <th>Açıklama</th>
                                                            <th>Süre</th>
                                                            <th>Ücret</th>
                                                            <th>İşlemler</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var service in Model.Services)
                                                        {
                                                            var collapseId = $"service-edit-{service.Id}";
                                                            <tr>
                                                                <td>@service.Name</td>
                                                                <td>@(string.IsNullOrWhiteSpace(service.Description) ? "-" : service.Description)</td>
                                                                <td>@(service.DurationMinutes.HasValue ? service.DurationMinutes + " dk" : "-")</td>
                                                                <td>@(service.Price.HasValue ? service.Price.Value.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("tr-TR")) : "-")</td>
                                                                <td>
                                                                    <div class="d-flex flex-column gap-2">
                                                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId">Düzenle</button>
                                                                        <form asp-action="DeleteService" method="post" onsubmit="return confirm('Bu hizmeti silmek istediğinize emin misiniz?');" class="d-inline">
                                                                            @Html.AntiForgeryToken()
                                                                            <input type="hidden" name="id" value="@service.Id" />
                                                                            <button type="submit" class="btn btn-sm btn-outline-danger">Sil</button>
                                                                        </form>
                                                                    </div>
                                                                    <div class="collapse mt-2" id="@collapseId">
                                                                        <div class="border rounded p-3 bg-body-tertiary">
                                                                            <form asp-action="EditService" method="post" class="row g-3">
                                                                                @Html.AntiForgeryToken()
                                                                                <input type="hidden" name="Id" value="@service.Id" />
                                                                                <div class="col-12">
                                                                                    <label for="service-name-@service.Id" class="form-label">Ad</label>
                                                                                    <input id="service-name-@service.Id" name="Name" value="@service.Name" maxlength="128" required class="form-control" />
                                                                                </div>
                                                                                <div class="col-12">
                                                                                    <label for="service-desc-@service.Id" class="form-label">Açıklama</label>
                                                                                    <textarea id="service-desc-@service.Id" name="Description" rows="2" maxlength="256" class="form-control">@service.Description</textarea>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <label for="service-duration-@service.Id" class="form-label">Süre (dk)</label>
                                                                                    <input id="service-duration-@service.Id" name="DurationMinutes" type="number" min="0" max="1440" value="@(service.DurationMinutes?.ToString() ?? string.Empty)" class="form-control" />
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <label for="service-price-@service.Id" class="form-label">Ücret</label>
                                                                                    <input id="service-price-@service.Id" name="Price" type="number" step="0.01" min="0" value="@(service.Price?.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) ?? string.Empty)" class="form-control" />
                                                                                </div>
                                                                                <div class="col-12">
                                                                                    <button type="submit" class="btn btn-primary btn-sm">Kaydet</button>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-5">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Yeni Hizmet Ekle</h5>
                                        <form asp-action="AddService" method="post" class="row g-3">
                                            @Html.AntiForgeryToken()
                                            <div class="col-12">
                                                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                            </div>
                                            <div class="col-12">
                                                <label asp-for="NewService.Name" class="form-label"></label>
                                                <input asp-for="NewService.Name" class="form-control" />
                                                <span asp-validation-for="NewService.Name" class="text-danger"></span>
                                            </div>
                                            <div class="col-12">
                                                <label asp-for="NewService.Description" class="form-label"></label>
                                                <textarea asp-for="NewService.Description" rows="2" class="form-control"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="NewService.DurationMinutes" class="form-label">Süre (dk)</label>
                                                <input asp-for="NewService.DurationMinutes" type="number" min="0" class="form-control" />
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="NewService.Price" class="form-label">Ücret</label>
                                                <input asp-for="NewService.Price" type="number" step="0.01" min="0" class="form-control" />
                                            </div>
                                            <div class="col-12">
                                                <button type="submit" class="btn btn-primary">Kaydet</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="admin-coaches" role="tabpanel" aria-labelledby="coaches-tab">
                        <div class="row g-4">
                            <div class="col-12 col-xl-7">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">Antrenör Listesi</h5>
                                        @if (!Model.Coaches.Any())
                                        {
                                            <p class="text-muted mb-0">Henüz kayıtlı antrenör bulunmuyor.</p>
                                        }
                                        else
                                        {
                                            <div class="vstack gap-3">
                                                @foreach (var coach in Model.Coaches)
                                                {
                                                    var coachCollapseId = $"coach-edit-{coach.Id}";
                                                    <div class="card border-0 shadow-sm">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between flex-wrap gap-2">
                                                                <div>
                                                                    <h6 class="mb-1">@coach.FullName</h6>
                                                                    @if (!string.IsNullOrWhiteSpace(coach.Bio))
                                                                    {
                                                                        <p class="text-muted mb-1">@coach.Bio</p>
                                                                    }
                                                                    <div>
                                                                        @if (!string.IsNullOrWhiteSpace(coach.ExpertiseTags))
                                                                        {
                                                                            foreach (var tag in coach.ExpertiseTags.Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries))
                                                                            {
                                                                                <span class="badge text-bg-light me-1 mb-1">@tag</span>
                                                                            }
                                                                        }
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        @if (coach.Services.Any())
                                                                        {
                                                                            foreach (var service in coach.Services)
                                                                            {
                                                                                <span class="coach-service-pill">@service</span>
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            <small class="text-muted">Hizmet atanmamış.</small>
                                                                        }
                                                                    </div>
                                                                </div>
                                                                <div class="text-end">
                                                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#@coachCollapseId">Düzenle</button>
                                                                    <form asp-action="DeleteCoach" method="post" onsubmit="return confirm('Bu antrenörü silmek istediğinize emin misiniz?');" class="d-inline">
                                                                        @Html.AntiForgeryToken()
                                                                        <input type="hidden" name="id" value="@coach.Id" />
                                                                        <button type="submit" class="btn btn-sm btn-outline-danger">Sil</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <div class="collapse mt-3" id="@coachCollapseId">
                                                                <div class="border rounded p-3 bg-body-tertiary">
                                                                    <form asp-action="EditCoach" method="post" class="row g-3">
                                                                        @Html.AntiForgeryToken()
                                                                        <input type="hidden" name="Id" value="@coach.Id" />
                                                                        <div class="col-12">
                                                                            <label class="form-label">Ad Soyad</label>
                                                                            <input type="text" name="FullName" value="@coach.FullName" maxlength="128" required class="form-control" />
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <label class="form-label">Uzmanlık Etiketleri</label>
                                                                            <textarea name="ExpertiseTags" rows="2" class="form-control">@coach.ExpertiseTags</textarea>
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <label class="form-label">Hizmetler</label>
                                                                            @if (Model.Services.Any())
                                                                            {
                                                                                <div class="row row-cols-1 row-cols-sm-2 g-2">
                                                                                    @foreach (var service in Model.Services)
                                                                                    {
                                                                                        var isChecked = coach.ServiceIds.Contains(service.Id);
                                                                                        <div class="col">
                                                                                            <div class="form-check">
                                                                                                <input class="form-check-input" type="checkbox" name="ServiceIds" value="@service.Id" @(isChecked ? "checked" : null) id="coach-@coach.Id-service-@service.Id" />
                                                                                                <label class="form-check-label" for="coach-@coach.Id-service-@service.Id">@service.Name</label>
                                                                                            </div>
                                                                                        </div>
                                                                                    }
                                                                                </div>
                                                                            }
                                                                            else
                                                                            {
                                                                                <div class="alert alert-warning mb-0">Önce hizmet ekleyin.</div>
                                                                            }
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <label class="form-label">Biyografi</label>
                                                                            <textarea name="Bio" rows="3" class="form-control">@coach.Bio</textarea>
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <button type="submit" class="btn btn-primary btn-sm">Güncelle</button>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-5">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">Yeni Antrenör Ekle</h5>
                                        <p class="text-muted small">Uzmanlık alanlarını virgülle veya satır satır yazabilirsiniz.</p>
                                        <form asp-action="AddCoach" method="post" class="row g-3">
                                            @Html.AntiForgeryToken()
                                            <div class="col-12">
                                                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                            </div>
                                            <div class="col-12">
                                                <label asp-for="NewCoach.FullName" class="form-label"></label>
                                                <input asp-for="NewCoach.FullName" class="form-control" />
                                                <span asp-validation-for="NewCoach.FullName" class="text-danger"></span>
                                            </div>
                                            <div class="col-12">
                                                <label asp-for="NewCoach.ExpertiseTags" class="form-label">Uzmanlık Etiketleri</label>
                                                <textarea asp-for="NewCoach.ExpertiseTags" rows="2" class="form-control"></textarea>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Hizmetler</label>
                                                @if (Model.Services.Any())
                                                {
                                                    <div class="row row-cols-1 row-cols-sm-2 g-2">
                                                        @foreach (var service in Model.Services)
                                                        {
                                                            var isChecked = Model.NewCoach.ServiceIds?.Contains(service.Id) ?? false;
                                                            <div class="col">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" name="NewCoach.ServiceIds" value="@service.Id" @(isChecked ? "checked" : null) id="newcoach-service-@service.Id" />
                                                                    <label class="form-check-label" for="newcoach-service-@service.Id">@service.Name</label>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="alert alert-warning mb-0">Önce hizmet ekleyin.</div>
                                                }
                                            </div>
                                            <div class="col-12">
                                                <label asp-for="NewCoach.Bio" class="form-label">Kısa Biyografi</label>
                                                <textarea asp-for="NewCoach.Bio" rows="3" class="form-control"></textarea>
                                            </div>
                                            <div class="col-12">
                                                <button type="submit" class="btn btn-primary">Kaydet</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="admin-coach-api" role="tabpanel" aria-labelledby="api-tab">
                        <div class="row g-4">
                            <div class="col-12 col-xl-6">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">REST API · Antrenör Arşivi</h5>
                                        <p class="text-muted">Bu sayfa doğrudan <code>/api/coaches</code> ve <code>/api/coaches/available</code> uçlarıyla konuşur.</p>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label for="apiDateInput" class="form-label">Tarih</label>
                                                <input type="date" id="apiDateInput" class="form-control" />
                                            </div>
                                            <div class="col-md-4">
                                                <label for="apiTimeSlotSelect" class="form-label">Saat</label>
                                                <select id="apiTimeSlotSelect" class="form-select">
                                                    @foreach (var slot in WebProje.Models.BookingTimeSlots.All)
                                                    {
                                                        <option value="@slot">@slot</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="apiServiceSelect" class="form-label">Hizmet</label>
                                                <select id="apiServiceSelect" class="form-select" @(Model.Services.Any() ? null : "disabled")>
                                                    @if (Model.Services.Any())
                                                    {
                                                        foreach (var service in Model.Services)
                                                        {
                                                            var durationText = service.DurationMinutes is null ? string.Empty : $" ({service.DurationMinutes} dk)";
                                                            <option value="@service.Id">@service.Name@durationText</option>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <option value="">Önce hizmet ekleyin</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-wrap gap-2 mt-3">
                                            <button type="button" class="btn btn-primary" id="apiFetchAll">Tüm Antrenörleri Getir</button>
                                            <button type="button" class="btn btn-outline-primary" id="apiFetchAvailable" @(Model.Services.Any() ? null : "disabled")>Bu Tarihte Müsait Olanları Listele</button>
                                        </div>
                                        <small class="text-muted d-block mt-2">Örnek istek: /api/coaches/available?date=2025-12-09&amp;timeSlot=10:00&amp;serviceId=1</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-6">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">API Yanıtı</h5>
                                        <div id="apiCoachStatus" class="alert alert-secondary" role="status" data-tone="muted">Henüz istek yapılmadı.</div>
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Ad</th>
                                                        <th>Uzmanlık</th>
                                                        <th>Hizmetler</th>
                                                        <th>Not</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="apiCoachTableBody">
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Veri bekleniyor.</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="admin-schedule" role="tabpanel" aria-labelledby="schedule-tab">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="card-title">Müsaitlik Takvimi</h5>
                                <p class="text-muted">Genel takvimi görüntüleyin, ardından koç seçerek yalnızca o koçun randevularını inceleyin.</p>
                                @{
                                    var culture = System.Globalization.CultureInfo.GetCultureInfo("tr-TR");
                                    var now = DateTime.Today;
                                    var monthStart = new DateOnly(now.Year, now.Month, 1);
                                    var daysInMonth = DateTime.DaysInMonth(monthStart.Year, monthStart.Month);
                                    var firstDayOffset = ((int)monthStart.DayOfWeek + 6) % 7;
                                    var totalCells = (int)Math.Ceiling((firstDayOffset + daysInMonth) / 7.0) * 7;
                                    var todayIso = DateOnly.FromDateTime(now).ToString("yyyy-MM-dd");
                                }
                                @if (!Model.CoachSchedules.Any())
                                {
                                    <div class="alert alert-warning mb-0">Henüz kayıtlı antrenör veya randevu bulunamadı.</div>
                                }
                                else
                                {
                                    <div class="row g-3 align-items-center mb-3">
                                        <div class="col-md-4">
                                            <label for="coachCalendarSelect" class="form-label">Koç Seçin</label>
                                            <select id="coachCalendarSelect" class="form-select">
                                                <option value="all" selected>Tüm Koçlar</option>
                                                @foreach (var coach in Model.CoachSchedules)
                                                {
                                                    <option value="@coach.Coach">@coach.Coach</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-0 fw-semibold" id="calendarCoachLabel">Tüm Koçlar</p>
                                            <small class="text-muted">Güncel görünüm</small>
                                        </div>
                                        <div class="col-md-4 text-md-end">
                                            <strong id="calendarMonthTitle">@monthStart.ToString("MMMM yyyy", culture)</strong>
                                            <div class="text-muted" id="calendarSummary"></div>
                                        </div>
                                    </div>
                                    <div class="calendar-grid" id="calendarGrid"></div>
                                    var schedulePayload = JsonSerializer.Serialize(
                                        Model.CoachSchedules.Select(cs => new
                                        {
                                            coach = cs.Coach,
                                            slots = cs.Slots.Select(slot => new
                                            {
                                                date = slot.Date.ToString("yyyy-MM-dd"),
                                                time = slot.TimeSlot,
                                                coach = cs.Coach,
                                                service = slot.Service
                                            })
                                        }),
                                        new JsonSerializerOptions
                                        {
                                            Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
                                        });
                                    <script
                                        type="application/json"
                                        id="coachScheduleData"
                                        data-month-prefix="@monthStart.ToString("yyyy-MM")"
                                        data-first-day-offset="@firstDayOffset"
                                        data-days-in-month="@daysInMonth"
                                        data-total-cells="@totalCells"
                                        data-month-label="@monthStart.ToString("MMMM yyyy", culture)"
                                        data-today-iso="@todayIso">
                                        @Html.Raw(schedulePayload)
                                    </script>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="admin-gym" role="tabpanel" aria-labelledby="gym-tab">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="card-title">Spor Salonu Bilgileri</h5>
                                <p class="text-muted">Çalışma saatleri, iletişim ve tanıtım bilgilerini güncel tutun.</p>
                                <form asp-action="UpdateGymInfo" method="post" class="row g-3" novalidate>
                                    @Html.AntiForgeryToken()
                                    <div class="col-12">
                                        <div asp-validation-summary="ModelOnly" class="text-danger" data-valmsg-summary="true"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="GymInfo.Name" class="form-label"></label>
                                        <input asp-for="GymInfo.Name" class="form-control" />
                                        <span asp-validation-for="GymInfo.Name" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="GymInfo.Phone" class="form-label"></label>
                                        <input asp-for="GymInfo.Phone" class="form-control" />
                                        <span asp-validation-for="GymInfo.Phone" class="text-danger"></span>
                                    </div>
                                    <div class="col-12">
                                        <label asp-for="GymInfo.Address" class="form-label"></label>
                                        <textarea asp-for="GymInfo.Address" rows="2" class="form-control"></textarea>
                                        <span asp-validation-for="GymInfo.Address" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="GymInfo.Email" class="form-label"></label>
                                        <input asp-for="GymInfo.Email" class="form-control" />
                                        <span asp-validation-for="GymInfo.Email" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="GymInfo.Website" class="form-label"></label>
                                        <input asp-for="GymInfo.Website" class="form-control" />
                                        <span asp-validation-for="GymInfo.Website" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="GymInfo.WeekdayHours" class="form-label"></label>
                                        <input asp-for="GymInfo.WeekdayHours" class="form-control" />
                                        <span asp-validation-for="GymInfo.WeekdayHours" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="GymInfo.WeekendHours" class="form-label"></label>
                                        <input asp-for="GymInfo.WeekendHours" class="form-control" />
                                        <span asp-validation-for="GymInfo.WeekendHours" class="text-danger"></span>
                                    </div>
                                    <div class="col-12">
                                        <label asp-for="GymInfo.About" class="form-label"></label>
                                        <textarea asp-for="GymInfo.About" rows="3" class="form-control"></textarea>
                                        <span asp-validation-for="GymInfo.About" class="text-danger"></span>
                                    </div>
                                    <div class="col-12">
                                        <label asp-for="GymInfo.Facilities" class="form-label"></label>
                                        <textarea asp-for="GymInfo.Facilities" rows="3" class="form-control"></textarea>
                                        <span asp-validation-for="GymInfo.Facilities" class="text-danger"></span>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">Bilgileri Kaydet</button>
                                    </div>
                                </form>
                                @if (Model.GymInfo?.UpdatedAtUtc is DateTime lastUpdate)
                                {
                                    <small class="text-muted">Son güncelleme: @lastUpdate.ToLocalTime().ToString("dd MMM yyyy HH:mm", System.Globalization.CultureInfo.GetCultureInfo("tr-TR"))</small>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        (() => {
            const rawMetrics = @Html.Raw(JsonSerializer.Serialize(Model.BookingUsageMetrics));
            const metrics = Array.isArray(rawMetrics) ? rawMetrics : [];
            const ctx = document.getElementById('usageChart');
            const categorySelect = document.getElementById('usageCategorySelect');
            const periodSelect = document.getElementById('usagePeriodSelect');
            const summaryList = document.getElementById('usageSummary');
            const wrapper = document.querySelector('.usage-chart-wrapper');

            if (!ctx || !categorySelect || !periodSelect) {
                return;
            }

            const linePalette = [
                { border: '#0ea5e9', background: 'rgba(14,165,233,0.15)' },
                { border: '#22c55e', background: 'rgba(34,197,94,0.15)' },
                { border: '#f97316', background: 'rgba(249,115,22,0.15)' },
                { border: '#a855f7', background: 'rgba(168,85,247,0.15)' },
                { border: '#6366f1', background: 'rgba(99,102,241,0.15)' },
                { border: '#ec4899', background: 'rgba(236,72,153,0.15)' }
            ];

            const chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', intersect: false },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#475569' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, stepSize: 1, color: '#475569' },
                            grid: { color: 'rgba(148,163,184,0.35)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#334155', usePointStyle: true }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: context => {
                                    const name = context.dataset?.label ?? 'Toplam';
                                    const value = context.parsed?.y ?? 0;
                                    return `${name}: ${value} randevu`;
                                }
                            }
                        }
                    }
                }
            });

            const buildSummary = (series) => {
                if (!summaryList) {
                    return;
                }
                summaryList.innerHTML = '';
                if (!series || series.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item text-muted';
                    li.textContent = 'Bu filtre için veri bulunamadı.';
                    summaryList.appendChild(li);
                    return;
                }
                series.slice(0, 5).forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between';
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = item.Label;
                    const countStrong = document.createElement('strong');
                    countStrong.textContent = `${item.Total}`;
                    li.appendChild(nameSpan);
                    li.appendChild(countStrong);
                    summaryList.appendChild(li);
                });
            };

            const updateChart = () => {
                const category = categorySelect.value;
                const period = periodSelect.value;
                const active = metrics.find(m => m.CategoryType === category && m.Period === period);
                const labels = active?.Labels ?? [];
                const series = active?.Series ?? [];

                chart.data.labels = labels;
                chart.data.datasets = series.map((line, index) => {
                    const colors = linePalette[index % linePalette.length];
                    return {
                        label: line.Label,
                        data: Array.isArray(line.Points) ? line.Points : [],
                        borderColor: colors.border,
                        backgroundColor: colors.background,
                        pointBorderColor: colors.border,
                        pointBackgroundColor: '#fff',
                        pointRadius: 4,
                        pointHoverRadius: 5,
                        borderWidth: 3,
                        tension: 0.35,
                        fill: false
                    };
                });

                chart.update('none');
                buildSummary(series);

                if (wrapper) {
                    const hasData = series.some(line => (line.Points ?? []).some(value => value > 0));
                    wrapper.dataset.empty = hasData ? 'false' : 'true';
                }
            };

            categorySelect.addEventListener('change', updateChart);
            periodSelect.addEventListener('change', updateChart);
            updateChart();
        })();
    </script>
    <script>
        (() => {
            const dataElement = document.getElementById('coachScheduleData');
            if (!dataElement) { return; }
            const scheduleData = JSON.parse(dataElement.textContent || '[]');
            const select = document.getElementById('coachCalendarSelect');
            const grid = document.getElementById('calendarGrid');
            const summary = document.getElementById('calendarSummary');
            const coachLabel = document.getElementById('calendarCoachLabel');
            const monthTitle = document.getElementById('calendarMonthTitle');
            const config = {
                monthPrefix: dataElement.dataset.monthPrefix || '',
                firstDayOffset: Number(dataElement.dataset.firstDayOffset || 0),
                daysInMonth: Number(dataElement.dataset.daysInMonth || 0),
                totalCells: Number(dataElement.dataset.totalCells || 42),
                monthLabel: dataElement.dataset.monthLabel || '',
                todayIso: dataElement.dataset.todayIso || ''
            };
            if (config.monthLabel) {
                monthTitle.textContent = config.monthLabel;
            }

            const getSlots = (coach) => {
                if (!coach || coach === 'all') {
                    return scheduleData.flatMap(item => item.slots || []);
                }
                const match = scheduleData.find(item => item.coach === coach);
                return match ? (match.slots || []) : [];
            };

            const buildCalendar = (slots) => {
                const filtered = slots.filter(slot => slot.date && slot.date.startsWith(config.monthPrefix));
                const map = filtered.reduce((acc, slot) => {
                    acc[slot.date] = acc[slot.date] || [];
                    acc[slot.date].push(slot);
                    return acc;
                }, {});
                const busyDays = Object.keys(map).length;
                summary.textContent = busyDays > 0 ? `${busyDays} gün dolu` : 'Tüm günler müsait';
                grid.innerHTML = '';
                for (let cell = 0; cell < config.totalCells; cell++) {
                    const dayNumber = cell - config.firstDayOffset + 1;
                    const cellDiv = document.createElement('div');
                    if (dayNumber < 1 || dayNumber > config.daysInMonth) {
                        cellDiv.className = 'calendar-day empty';
                        grid.appendChild(cellDiv);
                        continue;
                    }
                    const dateKey = `${config.monthPrefix}-${String(dayNumber).padStart(2, '0')}`;
                    const daySlots = map[dateKey] || [];
                    const isBusy = daySlots.length > 0;
                    const isPast = config.todayIso && dateKey < config.todayIso;
                    const classes = ['calendar-day'];
                    classes.push(isBusy ? 'booked' : 'available');
                    if (isPast) {
                        classes.push('past');
                    }
                    cellDiv.className = classes.join(' ');
                    const dayLabel = document.createElement('span');
                    dayLabel.className = 'fw-semibold';
                    dayLabel.textContent = dayNumber.toString();
                    cellDiv.appendChild(dayLabel);
                    if (isBusy) {
                        const list = document.createElement('ul');
                        daySlots.sort((a, b) => (a.time || '').localeCompare(b.time || '', 'tr-TR', { numeric: true }));
                        daySlots.forEach(slot => {
                            const item = document.createElement('li');
                            item.textContent = `${slot.time ?? ''} · ${slot.coach ?? ''} (${slot.service ?? ''})`;
                            list.appendChild(item);
                        });
                        cellDiv.appendChild(list);
                    }
                    grid.appendChild(cellDiv);
                }
            };

            const updateCalendar = () => {
                if (!select) {
                    return;
                }
                const selectedCoach = select.value;
                coachLabel.textContent = selectedCoach === 'all' ? 'Tüm Koçlar' : selectedCoach;
                const slots = getSlots(selectedCoach);
                buildCalendar(slots);
            };

            select?.addEventListener('change', updateCalendar);
            updateCalendar();
        })();
    </script>
    <script>
        (() => {
            const allButton = document.getElementById('apiFetchAll');
            const availableButton = document.getElementById('apiFetchAvailable');
            const statusEl = document.getElementById('apiCoachStatus');
            const tableBody = document.getElementById('apiCoachTableBody');
            const dateInput = document.getElementById('apiDateInput');
            const slotSelect = document.getElementById('apiTimeSlotSelect');
            const serviceSelect = document.getElementById('apiServiceSelect');

            if (!allButton || !statusEl || !tableBody) {
                return;
            }

            const setStatus = (message, tone = 'secondary') => {
                statusEl.textContent = message;
                statusEl.className = `alert alert-${tone}`;
            };

            const renderRows = (rows) => {
                if (!rows || rows.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sonuç bulunamadı.</td></tr>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    const fullName = row.fullName ?? row.FullName ?? '-';
                    const expertise = row.expertiseTags ?? row.ExpertiseTags ?? '-';
                    const servicesList = Array.isArray(row.services ?? row.Services) ? (row.services ?? row.Services) : [];
                    const services = servicesList.length > 0 ? servicesList.join(', ') : '-';
                    const requestedDate = row.requestedDate ?? row.RequestedDate;
                    const requestedSlot = row.requestedSlot ?? row.RequestedSlot;
                    const duration = row.requestedDurationMinutes ?? row.RequestedDurationMinutes;
                    const bio = row.bio ?? row.Bio;
                    const detail = requestedDate ? `${requestedDate} · ${requestedSlot ?? '-'}` + (duration ? ` (${duration} dk)` : '') : (bio ?? '-');
                    tr.innerHTML = `
                        <td>${fullName}</td>
                        <td>${expertise}</td>
                        <td>${services}</td>
                        <td>${detail}</td>`;
                    fragment.appendChild(tr);
                });
                tableBody.innerHTML = '';
                tableBody.appendChild(fragment);
            };

            const fetchJson = async (url) => {
                const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!response.ok) {
                    const payload = await response.text();
                    throw new Error(payload || 'Sunucu isteği başarısız oldu.');
                }
                return response.json();
            };

            const ensureDefaultDate = () => {
                if (!dateInput || dateInput.value) {
                    return;
                }
                const today = new Date();
                const iso = today.toISOString().split('T')[0];
                dateInput.value = iso;
            };

            allButton.addEventListener('click', async () => {
                setStatus('Antrenörler yükleniyor...', 'info');
                try {
                    const data = await fetchJson('/api/coaches');
                    renderRows(data);
                    setStatus(`${data.length} antrenör listelendi.`, 'success');
                }
                catch (error) {
                    setStatus(error.message, 'danger');
                }
            });

            if (availableButton && dateInput && slotSelect && serviceSelect) {
                availableButton.addEventListener('click', async () => {
                    const dateValue = dateInput.value;
                    const slotValue = slotSelect.value;
                    const serviceId = serviceSelect.value;
                    if (!dateValue || !slotValue || !serviceId) {
                        setStatus('Tarih, saat ve hizmet seçimleri zorunludur.', 'danger');
                        return;
                    }
                    setStatus('Müsait koçlar aranıyor...', 'info');
                    const params = new URLSearchParams({
                        date: dateValue,
                        timeSlot: slotValue,
                        serviceId: serviceId
                    });
                    try {
                        const data = await fetchJson(`/api/coaches/available?${params.toString()}`);
                        renderRows(data);
                        setStatus(data.length > 0 ? `${data.length} koç belirtilen aralıkta müsait.` : 'Bu aralıkta uygun koç yok.', 'success');
                    }
                    catch (error) {
                        setStatus(error.message, 'danger');
                    }
                });
            }

            ensureDefaultDate();
            allButton.click();
        })();
    </script>
</body>
</html>
