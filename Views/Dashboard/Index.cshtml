@model WebProje.Models.DashboardViewModel
@using System.Globalization
@using System.Linq
@using System.Text.Encodings.Web
@using System.Text.Json
@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = "Kullanıcı Paneli";
    var culture = CultureInfo.GetCultureInfo("tr-TR");
    var now = DateTime.Today;
    var monthStart = new DateOnly(now.Year, now.Month, 1);
    var daysInMonth = DateTime.DaysInMonth(monthStart.Year, monthStart.Month);
    var firstDayOffset = ((int)monthStart.DayOfWeek + 6) % 7;
    var totalCells = (int)Math.Ceiling((firstDayOffset + daysInMonth) / 7.0) * 7;
    var todayIso = DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd");
    var schedulePayload = JsonSerializer.Serialize(
        Model.Appointments.Select(slot => new
        {
            date = slot.Date.ToString("yyyy-MM-dd"),
            time = slot.TimeSlot,
            coach = slot.Coach,
            service = slot.Service,
            status = slot.Status
        }),
        new JsonSerializerOptions
        {
            Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
        });
}

@functions {
    public static string GetStatusLabel(string status) => status switch
    {
        WebProje.Models.AppointmentStatus.Approved => "Onaylandı",
        WebProje.Models.AppointmentStatus.Rejected => "Reddedildi",
        _ => "Beklemede"
    };

    public static string GetStatusClass(string status) => status switch
    {
        WebProje.Models.AppointmentStatus.Approved => "approved",
        WebProje.Models.AppointmentStatus.Rejected => "rejected",
        _ => "pending"
    };
}

<div class="dashboard-grid">
    @if (TempData["AppointmentMessage"] is string appointmentInfo)
    {
        <section class="appointment-card full-width">
            <div>
                <p class="stat-label">Son randevu</p>
                <h2>@appointmentInfo</h2>
            </div>
            <a class="action-btn appointment-btn" asp-controller="Appointment" asp-action="Book">Yeni Randevu Al</a>
        </section>
    }

    <section class="appointment-card full-width">
        <div>
            <p class="stat-label">Hazır mısınız?</p>
            <h2>Koçunuzla yeni bir seans planlayın</h2>
            <p>@Model.UserFullName, programınıza uygun tarihi ve saat dilimini seçin.</p>
        </div>
        <a class="action-btn appointment-btn" asp-controller="Appointment" asp-action="Book">Randevu Al</a>
    </section>

    <section class="schedule-card full-width">
        <header class="schedule-header">
            <div>
                <p class="stat-label">Aylık Takvim</p>
                <h2>@monthStart.ToString("MMMM yyyy", culture)</h2>
            </div>
            <div class="schedule-badge" id="userCalendarSummary">Takvim yükleniyor...</div>
        </header>
        <div class="user-calendar-meta">
            <span>@($"{Model.Appointments.Count} randevu kaydı")</span>
            <span>@Model.UserEmail</span>
        </div>
        <div class="user-calendar-grid" id="userCalendarGrid"></div>
        <div class="user-calendar-legend">
            <span class="status-pill approved">Onaylandı</span>
            <span class="status-pill pending">Beklemede</span>
            <span class="status-pill rejected">Reddedildi</span>
        </div>
        <div class="upcoming-block">
            <h3>Yaklaşan Randevular</h3>
            @if (Model.UpcomingAppointments.Any())
            {
                <div class="upcoming-list">
                    @foreach (var slot in Model.UpcomingAppointments)
                    {
                        <div class="upcoming-item">
                            <div>
                                <strong>@slot.Date.ToString("dd MMMM", culture) · @slot.TimeSlot</strong>
                                <div class="stat-label">@slot.Service · @slot.Coach</div>
                            </div>
                            <span class="status-pill @GetStatusClass(slot.Status)">@GetStatusLabel(slot.Status)</span>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="stat-label">Bu ay için planlanmış randevu bulunmuyor.</p>
            }
        </div>
    </section>

    <section class="leaderboard-card full-width">
        <div class="leaderboard-header">
            <div>
                <p class="stat-label">Class leaderboard</p>
                <h2>Haftanın randevu şampiyonları</h2>
                <p>Bu liste, bu hafta içinde onaylanmış ve tamamlanmış seans sayılarına göre güncellenir.</p>
            </div>
            <div class="leaderboard-tabs" role="tablist" aria-label="Liderlik kriterleri">
                <button type="button" class="leader-tab active" aria-selected="true">Randevular</button>
                <button type="button" class="leader-tab" disabled>Savings</button>
                <button type="button" class="leader-tab" disabled>Net worth</button>
                <button type="button" class="leader-tab" disabled>Credit score</button>
            </div>
        </div>

        @if (Model.WeeklyLeaderboard.Any())
        {
            var podium = Model.WeeklyLeaderboard.Take(3).ToList();
            var podiumOrdered = podium.Count >= 3
                ? new[] { podium[1], podium[0], podium[2] }
                : podium.ToArray();
            var others = Model.WeeklyLeaderboard.Skip(3).ToList();

            <div class="leaderboard-podium" aria-live="polite">
                @foreach (var entry in podiumOrdered)
                {
                    <article class="podium-item podium-rank-@entry.Rank">
                        <div class="podium-avatar" aria-hidden="true">
                            @if (!string.IsNullOrWhiteSpace(entry.AvatarUrl))
                            {
                                <img src="@entry.AvatarUrl" alt="@entry.DisplayName profil fotoğrafı" />
                            }
                            else
                            {
                                <span>@entry.Initials</span>
                            }
                        </div>
                        <div class="podium-meta">
                            <span class="podium-rank">#@entry.Rank</span>
                            <h3>@entry.DisplayName</h3>
                            <p>@entry.CompletedCount randevu</p>
                        </div>
                    </article>
                }
            </div>

            @if (others.Any())
            {
                <ul class="leaderboard-list">
                    @foreach (var entry in others)
                    {
                        <li>
                            <span class="rank-chip">#@entry.Rank</span>
                            <div class="leader-info">
                                <strong>@entry.DisplayName</strong>
                                <small>@entry.Email</small>
                            </div>
                            <span class="leader-score">@entry.CompletedCount</span>
                        </li>
                    }
                </ul>
            }
        }
        else
        {
            <div class="leaderboard-empty">
                Bu hafta henüz tamamlanmış randevu yok. İlk sen ol!
            </div>
        }

        <div class="leaderboard-footer">
            <a class="show-class-btn" asp-controller="Appointment" asp-action="Book">Show entire class</a>
        </div>
    </section>

    <div class="full-width">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Su tüketimi</div>
                <div class="stat-value">1.2 L</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Kalori</div>
                <div class="stat-value">2.54 kCal</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Kalp ritmi</div>
                <div class="stat-value">124 bpm</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Uyku</div>
                <div class="stat-value">13 saat</div>
            </div>
        </div>
    </div>

    <section class="activity-card full-width">
        <div class="activity-header">
            <div>
                <p class="stat-label">Antrenman Aktivitesi</p>
                <h2>Grafik Görünümü</h2>
                <p>Son antrenman randevularınızın onay durumuna göre otomatik güncellenir.</p>
            </div>
            <div class="activity-controls">
                <label>
                    <span>Zaman Aralığı</span>
                    <select id="activityRange" aria-label="Zaman aralığı seçimi">
                        <option value="week" selected>7 Gün</option>
                        <option value="month">4 Hafta</option>
                        <option value="year">12 Ay</option>
                    </select>
                </label>
                <label>
                    <span>Aktivite Türü</span>
                    <select id="activityType" aria-label="Aktivite türü seçimi">
                        <option value="">Tümü</option>
                        @foreach (var type in Model.ActivityTypes)
                        {
                            <option value="@type">@type</option>
                        }
                    </select>
                </label>
            </div>
        </div>
        <div class="activity-chart-shell">
            <canvas id="activityChart" aria-label="Antrenman aktivite grafiği" role="img"></canvas>
            <div class="activity-empty" data-activity-empty>Henüz onaylanmış aktivite yok.</div>
        </div>
    </section>

    <section class="progress-card">
        <header>
            <h2>İlerleme</h2>
        </header>
        <div class="progress-grid">
            <div class="progress-item">
                <strong>56 km</strong>
                <span>Haftalık mesafe</span>
            </div>
            <div class="progress-item">
                <strong>236 km</strong>
                <span>Toplam mesafe</span>
            </div>
            <div class="progress-item">
                <strong>10 saat</strong>
                <span>Kardio süresi</span>
            </div>
        </div>
        <button class="action-btn btn-upgrade">Programı güncelle</button>
    </section>

    <section class="subscription-card">
        <h3>Abonelik</h3>
        <p>Standart · Aylık</p>
        <button class="action-btn btn-upgrade">Pro'ya yükselt</button>
    </section>

    <section class="payment-card">
        <div class="payment-row">
            <div>
                <small>Ödeme</small>
                <div>22 Aralık 2025</div>
            </div>
            <button class="action-btn">Şimdi Öde</button>
        </div>
        <div class="payment-row">
            <div>
                <small>Varsayılan kart</small>
                <div>•••• 0018</div>
            </div>
            <button class="action-btn">Değiştir</button>
        </div>
    </section>

    <section class="offline-card">
        <h3>Offline Egzersizler</h3>
        <p>Kardio · Esneme · Single-leg</p>
    </section>

    <section class="attendance-card">
        <h3>Katılım</h3>
        <div class="attendance-grid">
            <span>S</span>
            <span>M</span>
            <span class="active">T</span>
            <span>W</span>
            <span>T</span>
            <span>F</span>
            <span>S</span>
        </div>
    </section>

    <section class="video-card">
        <h3>Video Aktivitesi</h3>
        <p>%78 tamamlandı</p>
        <div class="video-progress"></div>
    </section>

    <section class="trending-card">
        <h3>Trend Egzersizler</h3>
        <div class="trending-list">
            <div class="trending-item">
                <div class="trending-thumb"></div>
                <div>
                    <strong>Cardio Boost</strong>
                    <div class="stat-label">12M izleme</div>
                </div>
            </div>
            <div class="trending-item">
                <div class="trending-thumb"></div>
                <div>
                    <strong>Single-leg Stand</strong>
                    <div class="stat-label">8M izleme</div>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script type="application/json" id="userScheduleData">@Html.Raw(schedulePayload)</script>
    <script>
        (() => {
            const dataElement = document.getElementById('userScheduleData');
            const grid = document.getElementById('userCalendarGrid');
            const summary = document.getElementById('userCalendarSummary');
            if (!dataElement || !grid || !summary) {
                return;
            }
            const slots = JSON.parse(dataElement.textContent || '[]');
            const config = {
                monthPrefix: '@monthStart.ToString("yyyy-MM")',
                firstDayOffset: @firstDayOffset,
                daysInMonth: @daysInMonth,
                totalCells: @totalCells,
                todayIso: '@todayIso'
            };
            const bookingBaseUrl = '@Url.Action("Book", "Appointment")';
            const statusMap = {
                Approved: { label: 'Onaylandı', className: 'approved' },
                Rejected: { label: 'Reddedildi', className: 'rejected' },
                Pending: { label: 'Beklemede', className: 'pending' }
            };

            const navigateToBooking = (isoDate) => {
                if (!bookingBaseUrl) {
                    return;
                }
                const target = new URL(bookingBaseUrl, window.location.origin);
                target.searchParams.set('date', isoDate);
                window.location.href = target.toString();
            };

            const buildCalendar = () => {
                const filtered = slots.filter(slot => slot.date && slot.date.startsWith(config.monthPrefix));
                const grouped = filtered.reduce((acc, slot) => {
                    acc[slot.date] = acc[slot.date] || [];
                    acc[slot.date].push(slot);
                    return acc;
                }, {});

                const busyDays = Object.keys(grouped).length;
                summary.textContent = busyDays > 0 ? `${busyDays} gün dolu` : 'Henüz dolu gün yok';
                grid.innerHTML = '';

                for (let cell = 0; cell < config.totalCells; cell++) {
                    const dayNumber = cell - config.firstDayOffset + 1;
                    const cellDiv = document.createElement('div');

                    if (dayNumber < 1 || dayNumber > config.daysInMonth) {
                        cellDiv.className = 'user-calendar-day empty';
                        grid.appendChild(cellDiv);
                        continue;
                    }

                    const dateKey = `${config.monthPrefix}-${String(dayNumber).padStart(2, '0')}`;
                    const daySlots = grouped[dateKey] || [];
                    const isPast = dateKey < config.todayIso;
                    const modifier = daySlots.length === 0
                        ? 'free'
                        : daySlots.some(slot => slot.status === 'Approved') ? 'approved'
                        : daySlots.some(slot => slot.status === 'Pending') ? 'pending'
                        : 'rejected';

                    const classList = ['user-calendar-day', modifier];
                    if (isPast) {
                        classList.push('past');
                    }
                    cellDiv.className = classList.join(' ');
                    cellDiv.dataset.date = dateKey;

                    const dayLabel = document.createElement('span');
                    dayLabel.className = 'day-number';
                    dayLabel.textContent = dayNumber.toString();
                    cellDiv.appendChild(dayLabel);

                    if (daySlots.length === 0) {
                        // no status chip; leave cell clean
                    } else {
                        const list = document.createElement('ul');
                        daySlots.sort((a, b) => (a.time || '').localeCompare(b.time || '', 'tr-TR', { numeric: true }));
                        daySlots.forEach(slot => {
                            const item = document.createElement('li');
                            const info = document.createElement('span');
                            info.textContent = `${slot.time ?? ''} · ${slot.coach ?? ''}`;
                            const badge = document.createElement('span');
                            const meta = statusMap[slot.status] || statusMap.Pending;
                            badge.className = `status-pill ${meta.className}`;
                            badge.textContent = meta.label;
                            item.appendChild(info);
                            item.appendChild(badge);
                            list.appendChild(item);
                        });
                        cellDiv.appendChild(list);
                    }

                    if (!isPast) {
                        const triggerBooking = () => navigateToBooking(dateKey);
                        const handleNavigate = (event) => {
                            if (event.type === 'click' || (event.type === 'keydown' && (event.key === 'Enter' || event.key === ' '))) {
                                event.preventDefault();
                                triggerBooking();
                            }
                        };
                        cellDiv.classList.add('clickable');
                        cellDiv.setAttribute('role', 'button');
                        cellDiv.tabIndex = 0;
                        cellDiv.setAttribute('title', 'Randevu al');
                        cellDiv.addEventListener('click', handleNavigate);
                        cellDiv.addEventListener('keydown', handleNavigate);

                        const ctaButton = document.createElement('button');
                        ctaButton.type = 'button';
                        ctaButton.className = 'calendar-cta';
                        ctaButton.textContent = 'Randevu al';
                        ctaButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            triggerBooking();
                        });
                        cellDiv.appendChild(ctaButton);
                    }

                    grid.appendChild(cellDiv);
                }
            };

            buildCalendar();
        })();

        (() => {
            const chartElement = document.getElementById('activityChart');
            if (!chartElement) {
                return;
            }

            const rangeSelect = document.getElementById('activityRange');
            const typeSelect = document.getElementById('activityType');
            const emptyState = document.querySelector('[data-activity-empty]');
            const endpoint = '@Url.Action("ActivityData", "Dashboard")';
            const paletteFallback = ['#ff4081', '#00bcd4', '#9c27b0', '#ffc107', '#4caf50'];
            let chartInstance;

            const buildQuery = () => {
                const params = new URLSearchParams();
                params.set('range', rangeSelect?.value ?? 'week');
                if (typeSelect?.value) {
                    params.set('type', typeSelect.value);
                }
                return params.toString();
            };

            const renderChart = (payload) => {
                const datasets = (payload.datasets ?? []).map((dataset, index) => {
                    const color = dataset.color ?? paletteFallback[index % paletteFallback.length];
                    return {
                        label: dataset.label,
                        data: dataset.data,
                        borderColor: color,
                        backgroundColor: color,
                        fill: false,
                        tension: 0.35,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    };
                });

                const hasData = datasets.some(ds => (ds.data ?? []).some(value => value > 0));
                if (emptyState) {
                    emptyState.style.display = hasData ? 'none' : 'flex';
                }

                if (chartInstance) {
                    chartInstance.destroy();
                }

                chartInstance = new Chart(chartElement, {
                    type: 'line',
                    data: {
                        labels: payload.labels,
                        datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: datasets.length > 1
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            };

            const loadData = async () => {
                try {
                    const response = await fetch(`${endpoint}?${buildQuery()}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    if (!response.ok) {
                        return;
                    }
                    const payload = await response.json();
                    renderChart(payload);
                } catch (error) {
                    if (emptyState) {
                        emptyState.style.display = 'flex';
                        emptyState.textContent = 'Veri yüklenemedi.';
                    }
                }
            };

            rangeSelect?.addEventListener('change', loadData);
            typeSelect?.addEventListener('change', loadData);
            loadData();
        })();
    </script>
}
