@using System.Linq
@model WebProje.Models.DietPlanViewModel
@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = "Diyet Planım";

    var primaryVisual = Model.MealVisuals?.FirstOrDefault();
    var mealLegend = Model.MealIdeas?
        .Where(meal => meal is not null)
        .Select(meal =>
        {
            var title = string.IsNullOrWhiteSpace(meal!.Meal) ? "Öğün" : meal.Meal;
            return string.IsNullOrWhiteSpace(meal.Description) ? title : $"{title}: {meal.Description}";
        })
        .Where(text => !string.IsNullOrWhiteSpace(text))
        .ToList()
        ?? new List<string>();
}

<div class="diet-page">
    <section class="profile-card diet-ai-banner">
        <div>
            <p class="stat-label">@Model.Ai.Source</p>
            <h2>
                @(Model.Ai.GeneratedByAi
                    ? (!string.IsNullOrWhiteSpace(Model.Ai.PlanTitle) ? Model.Ai.PlanTitle : "Yapay Zeka Diyet Planı")
                    : "BarbieFit Standart Öneri")
            </h2>
            <p>
                @if (!string.IsNullOrWhiteSpace(Model.Ai.MotivationMessage))
                {
                    @Model.Ai.MotivationMessage
                }
                else if (!string.IsNullOrWhiteSpace(Model.Ai.ErrorMessage))
                {
                    @Model.Ai.ErrorMessage
                }
                else
                {
                    <text>Profil ölçümlerine göre yenilenmiş öneriler burada.</text>
                }
            </p>

            <div class="ai-meta">
                <span class="pill @(Model.Ai.GeneratedByAi ? "pill-positive" : "pill-muted")">
                    @(Model.Ai.GeneratedByAi ? "AI Aktif" : "Standart Plan")
                </span>
                @if (!string.IsNullOrWhiteSpace(Model.Ai.Model))
                {
                    <span class="pill">@Model.Ai.Model</span>
                }
            </div>

            @if (Model.Ai.Cautions?.Any() == true)
            {
                <ul class="ai-cautions">
                    @foreach (var caution in Model.Ai.Cautions)
                    {
                        <li>@caution</li>
                    }
                </ul>
            }

            @if (!string.IsNullOrWhiteSpace(Model.Ai.ErrorMessage))
            {
                <div class="ai-alert">@Model.Ai.ErrorMessage</div>
            }
        </div>
    </section>

    <section class="profile-card diet-hero">
        <div>
            <p class="stat-label">Kişisel Diyet Planı</p>
            <h1>@Model.UserFullName</h1>
            <p>Vücut kitle indeksine göre BarbieFit tarafından hazırlanan günlük yönlendirmeler.</p>
            <div class="diet-hero-stats">
                <div>
                    <small>BMI</small>
                    <strong>@(Model.BodyMassIndex?.ToString("0.0") ?? "—")</strong>
                    <span>@Model.BmiCategory</span>
                </div>
                <div>
                    <small>Günlük Kalori</small>
                    <strong>@Model.SuggestedCalories</strong>
                    <span>kcal</span>
                </div>
                <div>
                    <small>Su Hedefi</small>
                    <strong>@Model.HydrationLiters.ToString("0.0") L</strong>
                    <span>Günlük</span>
                </div>
            </div>
        </div>
        <div class="diet-hero-visual" aria-hidden="true"></div>
    </section>

    <section class="diet-grid">
        <article class="diet-card macro-card">
            <h2>Makro Dağılımı</h2>
            <p>Enerjini dengede tutmak için önerilen yüzdeler.</p>
            <div class="macro-bars">
                <div class="macro-bar">
                    <span>Karbonhidrat</span>
                    <div class="macro-track">
                        <div class="macro-fill" style="width:@Model.MacroSplit.CarbsPercent%;background:#ff80ab"></div>
                    </div>
                    <strong>@Model.MacroSplit.CarbsPercent%</strong>
                </div>
                <div class="macro-bar">
                    <span>Protein</span>
                    <div class="macro-track">
                        <div class="macro-fill" style="width:@Model.MacroSplit.ProteinPercent%;background:#80cbc4"></div>
                    </div>
                    <strong>@Model.MacroSplit.ProteinPercent%</strong>
                </div>
                <div class="macro-bar">
                    <span>Yağ</span>
                    <div class="macro-track">
                        <div class="macro-fill" style="width:@Model.MacroSplit.FatPercent%;background:#ffcc80"></div>
                    </div>
                    <strong>@Model.MacroSplit.FatPercent%</strong>
                </div>
            </div>
        </article>

        <article class="diet-card focus-card">
            <h2>Bugün Odaklan</h2>
            <ul>
                @foreach (var tip in Model.FocusTips ?? Array.Empty<string>())
                {
                    <li>@tip</li>
                }
            </ul>
        </article>

        <article class="diet-card meals-card">
            <h2>Örnek Öğünler</h2>
            <div class="meal-list">
                @foreach (var meal in Model.MealIdeas ?? Array.Empty<WebProje.Models.DietMealIdea>())
                {
                    if (meal is null)
                    {
                        continue;
                    }

                    <div class="meal-chip" style="border-color:@meal.Accent;box-shadow:0 8px 15px rgba(0,0,0,0.05);">
                        <small>@meal.Meal</small>
                        <p>@meal.Description</p>
                    </div>
                }
            </div>
        </article>
    </section>

    <section class="profile-card diet-gallery">
        <div class="diet-gallery-head">
            <div>
                <p class="stat-label">Görsel Menü</p>
                <h2>Örnek Tabak Kompozisyonları</h2>
                <p>Diyet planındaki her öğün için sunum ve porsiyon fikirlerini görselleştirir.</p>
            </div>
            <div class="diet-gallery-note">
                Temsili görseller · Aynı renk kodları raporlarda da kullanılır.
            </div>
            @if (!string.IsNullOrWhiteSpace(Model.MealVisualErrorMessage))
            {
                <div class="ai-alert">@Model.MealVisualErrorMessage</div>
            }
        </div>
        <div class="diet-gallery-grid">
            @if (primaryVisual is WebProje.Models.DietMealVisual visual)
            {
                var resolvedSrc = string.IsNullOrWhiteSpace(visual.ImageUrl)
                    ? Url.Content("~/images/diet/menu-collage.svg")
                    : (visual.ImageUrl.StartsWith("http", StringComparison.OrdinalIgnoreCase) || visual.ImageUrl.StartsWith("data:", StringComparison.OrdinalIgnoreCase)
                        ? visual.ImageUrl
                        : Url.Content(visual.ImageUrl));
                <figure class="meal-visual-card" style="--meal-accent:@visual.Accent">
                    <div class="meal-image-shell">
                        <img src="@resolvedSrc" alt="Tüm öğünleri tek görselde gösteren öneri" loading="lazy" />
                    </div>
                    <figcaption>
                        <small>Günlük Menü</small>
                        <p>@visual.Description</p>
                        @if (mealLegend.Count > 0)
                        {
                            <ul class="meal-legend">
                                @foreach (var legend in mealLegend)
                                {
                                    <li>@legend</li>
                                }
                            </ul>
                        }
                    </figcaption>
                    <span class="meal-visual-chip">AI Menü</span>
                </figure>
            }
            else
            {
                <div class="meal-visual-placeholder">Görsel yüklenemedi.</div>
            }
        </div>
    </section>

    <div class="diet-actions">
        <a class="action-btn diet-secondary" asp-action="Profile">Profilime Dön</a>
        <a class="action-btn appointment-btn" asp-controller="Appointment" asp-action="Book">Koçumla Paylaş</a>
    </div>
</div>
