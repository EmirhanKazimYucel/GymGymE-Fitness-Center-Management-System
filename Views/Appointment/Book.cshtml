@model WebProje.Models.AppointmentViewModel
@using System.Text.Json
@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = "Randevu Oluştur";
    var hasServices = Model.Services.Any();
    var coachData = JsonSerializer.Serialize(Model.ServiceCoachMap);
    var today = DateOnly.FromDateTime(DateTime.Today);
}

<div class="dashboard-grid">
    <section class="workout-card full-width">
        <header class="form-header">
            <div>
                <h2>Randevu Planla</h2>
                <p class="stat-label">Koçunuzla hızlıca seans oluşturun.</p>
            </div>
            <a asp-controller="Dashboard" asp-action="Index" class="action-btn muted-btn">Panele Dön</a>
        </header>
        @{
            var coachItems = Model.AvailableCoaches.Select(name => new SelectListItem { Value = name, Text = name }).ToList();
            var hasCoaches = coachItems.Any();
        }
        <form asp-action="Book" method="post" class="form-grid">
            <div asp-validation-summary="ModelOnly" class="validation"></div>
            <div class="full-width info-card">
                <p class="stat-label">Hesap Bilgileriniz</p>
                <div class="info-grid">
                    <div>
                        <strong>@Model.UserFullName</strong>
                        <div class="stat-label">@Model.UserEmail</div>
                    </div>
                    <div>
                        <span class="stat-label">Telefon</span>
                        <div>@(string.IsNullOrWhiteSpace(Model.UserPhone) ? "-" : Model.UserPhone)</div>
                    </div>
                </div>
            </div>
            <div>
                <label asp-for="SelectedServiceId"></label>
                @if (hasServices)
                {
                    <select asp-for="SelectedServiceId" asp-items="@(new SelectList(Model.Services, "Id", "Name", Model.SelectedServiceId))" id="serviceSelect"></select>
                }
                else
                {
                    <select disabled>
                        <option value="">Henüz hizmet bulunmuyor</option>
                    </select>
                }
                <span asp-validation-for="SelectedServiceId" class="validation"></span>
                @if (!hasServices)
                {
                    <small class="stat-label">Admin yeni hizmet tanımladığında randevu açılacaktır.</small>
                }
            </div>
            <div>
                <label asp-for="SelectedDate"></label>
                <input asp-for="SelectedDate"
                       type="date"
                       value="@Model.SelectedDate.ToString("yyyy-MM-dd")"
                       min="@today.ToString("yyyy-MM-dd")" />
                <span asp-validation-for="SelectedDate" class="validation"></span>
            </div>
            <div>
                <label asp-for="SelectedTime"></label>
                <select asp-for="SelectedTime" asp-items="@(new SelectList(Model.TimeSlots))"></select>
                <span asp-validation-for="SelectedTime" class="validation"></span>
            </div>
            <div>
                <label asp-for="SelectedCoach"></label>
                @if (hasCoaches)
                {
                    <select asp-for="SelectedCoach" asp-items="coachItems" id="coachSelect"></select>
                }
                else
                {
                    <select id="coachSelect" disabled>
                        <option value="">Seçili hizmet için koç yok</option>
                    </select>
                }
                <span asp-validation-for="SelectedCoach" class="validation"></span>
                @if (!hasCoaches)
                {
                    <small class="stat-label">Seçtiğiniz hizmet için uygun antrenör bulunamadı.</small>
                }
            </div>
            <div class="full-width">
                <label asp-for="Notes"></label>
                <textarea asp-for="Notes" rows="3"></textarea>
                <span asp-validation-for="Notes" class="validation"></span>
            </div>
            <div class="form-actions">
                <button type="submit" class="action-btn btn-upgrade" id="submitBooking" @(hasCoaches && hasServices ? null : "disabled")>Talebi Gönder</button>
            </div>
        </form>
    </section>
</div>

@section Scripts {
    <script>
        const serviceCoachMap = @Html.Raw(coachData);
        const serviceSelect = document.getElementById('serviceSelect');
        const coachSelect = document.getElementById('coachSelect');
        const submitBtn = document.getElementById('submitBooking');
        if (serviceSelect && coachSelect && submitBtn) {
            let selectedCoach = coachSelect.value;
            const refreshCoaches = keepSelection => {
                const serviceId = serviceSelect.value;
                const options = serviceCoachMap[serviceId] || [];
                coachSelect.innerHTML = '';
                if (options.length === 0) {
                    coachSelect.disabled = true;
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Bu hizmet için koç yok';
                    coachSelect.appendChild(emptyOption);
                } else {
                    coachSelect.disabled = false;
                    const target = keepSelection ? selectedCoach : '';
                    options.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        if (target && name === target) {
                            opt.selected = true;
                        }
                        coachSelect.appendChild(opt);
                    });
                    if (!coachSelect.value) {
                        coachSelect.value = options[0];
                    }
                }
                submitBtn.disabled = options.length === 0;
            };
            refreshCoaches(true);
            serviceSelect.addEventListener('change', () => {
                selectedCoach = '';
                refreshCoaches(false);
            });
            coachSelect.addEventListener('change', () => {
                selectedCoach = coachSelect.value;
            });
        }
    </script>
    <partial name="_ValidationScriptsPartial" />
}
