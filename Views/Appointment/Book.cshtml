@model WebProje.Models.AppointmentViewModel
@using System.Text.Json
@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = "Randevu Oluştur";
    var hasServices = Model.Services.Any();
    var hasTimeSlots = Model.TimeSlots.Any();
    var coachData = JsonSerializer.Serialize(Model.ServiceCoachMap);
    var today = DateOnly.FromDateTime(DateTime.Today);
}

<div class="dashboard-grid">
    <section class="workout-card full-width">
        <header class="form-header">
            <div>
                <h2>Randevu Planla</h2>
                <p class="stat-label">Koçunuzla hızlıca seans oluşturun.</p>
            </div>
            <a asp-controller="Dashboard" asp-action="Index" class="action-btn muted-btn">Panele Dön</a>
        </header>
        <form asp-action="Book" method="post" class="form-grid">
            <div asp-validation-summary="ModelOnly" class="validation"></div>
            <div class="full-width info-card">
                <p class="stat-label">Hesap Bilgileriniz</p>
                <div class="info-grid">
                    <div>
                        <strong>@Model.UserFullName</strong>
                        <div class="stat-label">@Model.UserEmail</div>
                    </div>
                    <div>
                        <span class="stat-label">Telefon</span>
                        <div>@(string.IsNullOrWhiteSpace(Model.UserPhone) ? "-" : Model.UserPhone)</div>
                    </div>
                </div>
            </div>
            <div>
                <label asp-for="SelectedServiceId"></label>
                @if (hasServices)
                {
                    <select asp-for="SelectedServiceId" id="serviceSelect">
                        <option value="">Hizmet seçiniz</option>
                        @foreach (var service in Model.Services)
                        {
                            <option value="@service.Id">@service.Name</option>
                        }
                    </select>
                }
                else
                {
                    <select disabled>
                        <option value="">Henüz hizmet bulunmuyor</option>
                    </select>
                }
                <span asp-validation-for="SelectedServiceId" class="validation"></span>
                @if (!hasServices)
                {
                    <small class="stat-label">Admin yeni hizmet tanımladığında randevu açılacaktır.</small>
                }
            </div>
            <div>
                <label asp-for="SelectedDate"></label>
                <input asp-for="SelectedDate"
                       type="date"
                       value="@Model.SelectedDate.ToString("yyyy-MM-dd")"
                       min="@today.ToString("yyyy-MM-dd")" />
                <span asp-validation-for="SelectedDate" class="validation"></span>
            </div>
            <div>
                <label asp-for="SelectedTime"></label>
                @if (hasTimeSlots)
                {
                    <select asp-for="SelectedTime" id="timeSelect">
                        <option value="">Saat seçiniz</option>
                        @foreach (var slot in Model.TimeSlots)
                        {
                            <option value="@slot">@slot</option>
                        }
                    </select>
                }
                else
                {
                    <select asp-for="SelectedTime" id="timeSelect" disabled="disabled">
                        <option value="">Bu tarih için uygun saat yok</option>
                    </select>
                }
                <span asp-validation-for="SelectedTime" class="validation"></span>
                @if (!hasTimeSlots)
                {
                    <small class="stat-label">
                        @(
                            Model.GymClosedForSelectedDate
                                ? "Seçtiğiniz gün salon kapalı."
                                : (Model.NoRemainingSlotsForToday && Model.SelectedDate == today)
                                    ? "Bugün için kalan saat bulunmuyor."
                                    : "Bu tarih için çalışma saatleri tanımlanmadı."
                        )
                    </small>
                }
            </div>
            <div>
                <label asp-for="SelectedCoach"></label>
                <select asp-for="SelectedCoach" id="coachSelect" data-selected-coach="@Model.SelectedCoach" disabled>
                    <option value="">Önce hizmet seçiniz</option>
                </select>
                <span asp-validation-for="SelectedCoach" class="validation"></span>
            </div>
            <div class="full-width">
                <label asp-for="Notes"></label>
                <textarea asp-for="Notes" rows="3"></textarea>
                <span asp-validation-for="Notes" class="validation"></span>
            </div>
            <div class="form-actions">
                <button type="submit" class="action-btn btn-upgrade" id="submitBooking" disabled>Talebi Gönder</button>
            </div>
        </form>
    </section>
</div>

@section Scripts {
    <script>
        const bookingUrl = '@Url.Action("Book", "Appointment")';
        const dateInput = document.querySelector('input[name="SelectedDate"]');
        dateInput?.addEventListener('change', () => {
            if (!bookingUrl || !dateInput.value) {
                return;
            }

            const hasQuery = bookingUrl.includes('?');
            const target = `${bookingUrl}${hasQuery ? '&' : '?'}date=${dateInput.value}`;
            window.location.href = target;
        });

        const serviceCoachMap = @Html.Raw(coachData);
        const serviceSelect = document.getElementById('serviceSelect');
        const coachSelect = document.getElementById('coachSelect');
        const timeSelect = document.getElementById('timeSelect');
        const submitBtn = document.getElementById('submitBooking');

        const updateSubmitState = () => {
            if (!submitBtn) {
                return;
            }
            const timeReady = timeSelect && !timeSelect.disabled && timeSelect.value;
            submitBtn.disabled = !(serviceSelect?.value && timeReady && coachSelect?.value);
        };

        if (serviceSelect && coachSelect && submitBtn) {
            let selectedCoach = coachSelect.dataset.selectedCoach ?? '';

            const buildOption = (value, label, { disabled = false, selected = false } = {}) => {
                const opt = document.createElement('option');
                opt.value = value;
                opt.textContent = label;
                if (disabled) opt.disabled = true;
                if (selected) opt.selected = true;
                return opt;
            };

            const refreshCoaches = (preserveSelection) => {
                const serviceId = serviceSelect.value;
                coachSelect.innerHTML = '';

                if (!serviceId) {
                    coachSelect.disabled = true;
                    coachSelect.appendChild(buildOption('', 'Önce hizmet seçiniz', { selected: true }));
                    updateSubmitState();
                    return;
                }

                const options = serviceCoachMap[serviceId] || [];
                if (options.length === 0) {
                    coachSelect.disabled = true;
                    coachSelect.appendChild(buildOption('', 'Bu hizmet için koç yok', { selected: true }));
                    updateSubmitState();
                    return;
                }

                coachSelect.disabled = false;
                const target = preserveSelection ? (selectedCoach || '') : '';
                coachSelect.appendChild(buildOption('', 'Koç seçiniz', { disabled: true, selected: !target }));
                options.forEach(name => {
                    const opt = buildOption(name, name, { selected: target === name });
                    coachSelect.appendChild(opt);
                });
                if (!coachSelect.value && options.length > 0 && target) {
                    coachSelect.value = target;
                }

                updateSubmitState();
            };

            serviceSelect.addEventListener('change', () => {
                selectedCoach = '';
                refreshCoaches(false);
            });

            coachSelect.addEventListener('change', () => {
                selectedCoach = coachSelect.value;
                updateSubmitState();
            });

            timeSelect?.addEventListener('change', updateSubmitState);

            refreshCoaches(true);
            updateSubmitState();
        }
    </script>
    <partial name="_ValidationScriptsPartial" />
}
